#!/bin/bash

# Get a list of all projects in the organization
org_id="339867572913"

# Get a list of projects under the specified organization ID
projects=$(gcloud asset search-all-resources \
  --scope="organizations/$org_id" \
  --asset-types='cloudresourcemanager.googleapis.com/Project' \
  --format="value(additionalAttributes.projectId)")

for project in $projects; do
  echo "Project: $project"
  # Verify if compute engine API is enabled
  if gcloud services list --enabled --project $project | grep compute.googleapis.com > /dev/null
  then
  echo compute api enabled
    # Get a list of Linux GCE instances in the current project
    #echo gcloud compute instances list --project="$project" --filter="status=RUNNING" --format="csv(name,zone)"
    instances=$(gcloud compute instances list --project="$project" --filter="status=RUNNING" --format="csv(name,zone)")
    for instance in $instances; do

      instance_name=$(echo $instance | awk -F ',' '{print $1}')
      instance_zone=$(echo $instance | awk -F ',' '{print $2}') 
      echo $instance_name
      COMMAND=$(cat fix.sh | tr '\n' ';')
      gcloud compute ssh $instance_name --zone=$instance_zone --project=$project --tunnel-through-iap --command="$COMMAND"


      echo OK
    done
  fi
  echo ""  # Add an empty line for better readability
done
